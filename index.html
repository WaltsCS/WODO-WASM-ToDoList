<!doctype html>
<html lang="en-us">
<head>
  <meta charset="utf-8" />
  <title>WODO: To-Do (WASM)</title>

  <link rel="manifest" href="manifest.json" />
  <meta name="theme-color" content="#111827" />

  <!-- ★ MOBILE VIEWPORT FIX -->
  <meta name="viewport" content="width=device-width, initial-scale=1.15, maximum-scale=1.15">

  <style>
    * { box-sizing: border-box; }

    body {
      margin: 0;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      background: radial-gradient(circle at top, #111827 0, #020617 55%, #000 100%);
      color: #e5e7eb;
      font-family: Arial, sans-serif;
    }

    header {
      margin: 24px 0 14px;
      letter-spacing: 0.12em;
      font-weight: 700;
      text-transform: uppercase;
      font-size: 24px;
      text-align: center;
    }

    /* ★ Expanded max-width from 900 → 1100 */
    .app-frame {
      width: min(1100px, 95%);
      background: rgba(15, 23, 42, 0.96);
      border-radius: 20px;
      padding: 18px 22px 26px;
      box-shadow:
        0 18px 45px rgba(15, 23, 42, 0.9),
        0 0 0 1px rgba(148, 163, 184, 0.15);
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    /* ---------- Toolbar ---------- */
    .toolbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
    }

    .toolbar-left {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    /* ---------- Buttons ---------- */
    button {
      cursor: pointer;
      border-radius: 999px;
      border: none;
      font-weight: 600;
      font-size: 15px;  /* ★ Larger base size */
    }

    .btn-primary {
      background: linear-gradient(to right, #22c55e, #4ade80);
      color: #022c22;
      padding: 10px 22px; /* ★ Larger */
    }

    .btn-primary:hover { filter: brightness(1.05); }

    .btn-ghost {
      background: transparent;
      color: #9ca3af;
      border: 1px solid rgba(55, 65, 81, 0.8);
      padding: 10px 22px;
    }

    .btn-ghost:hover {
      border-color: #f97316;
      color: #f97316;
    }

    /* ---------- Task List ---------- */
    .todo-list {
      list-style: none;
      margin: 0;
      padding: 0;
      border-radius: 16px;
      background: rgba(15, 23, 42, 0.95);
      box-shadow: inset 0 0 0 1px rgba(31, 41, 55, 0.9);
      max-height: 460px;
      overflow-y: auto;
    }

    .todo-empty {
      padding: 46px 30px;
      text-align: center;
      color: #6b7280;
      font-size: 16px; /* ★ slightly larger */
    }

    .todo-item {
      padding: 14px 18px;
      border-bottom: 1px solid rgba(31, 41, 55, 0.8);
      display: flex;
      flex-wrap: wrap;
      gap: 8px 14px;
      align-items: center;
      justify-content: space-between;
    }

    .todo-item:last-child { border-bottom: none; }

    /* Left side: check + text */
    .todo-left {
      display: flex;
      align-items: center;
      gap: 12px;
      flex: 1;
      min-width: 240px;
    }

    .todo-check {
      width: 30px;
      height: 30px;
      border-radius: 50%;
      border: 1px solid rgba(75, 85, 99, 0.9);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px; /* ★ Larger checkmark */
      cursor: pointer;
      flex-shrink: 0;
    }

    .todo-item.done .todo-check {
      background: #22c55e;
      border-color: #22c55e;
      color: #022c22;
    }

    .todo-text {
      flex: 1;
      cursor: pointer;
      font-size: 17px; /* ★ Larger text */
    }

    .todo-item.done .todo-text {
      text-decoration: line-through;
      color: #9ca3af;
    }

    /* Right side buttons */
    .todo-actions {
      display: flex;
      gap: 10px;
      flex-shrink: 0;
    }

    .btn-small {
      padding: 8px 16px;  /* ★ Bigger on desktop too */
      font-size: 15px;
      border-radius: 999px;
      border: 1px solid rgba(75, 85, 99, 0.9);
      background: rgba(15, 23, 42, 0.9);
      color: #e5e7eb;
    }

    .btn-small.delete {
      border-color: rgba(248, 113, 113, 0.9);
      color: #fca5a5;
    }

    .btn-small.delete:hover { background: rgba(248, 113, 113, 0.15); }

    .btn-small.edit:hover {
      border-color: #60a5fa;
      color: #bfdbfe;
    }

    /* ---------- Console ---------- */
    #output {
      width: 100%;
      height: 160px; /* ★ slightly taller */
      background: #020617;
      color: #a3e635;
      border-radius: 14px;
      border: 1px solid rgba(51, 65, 85, 0.9);
      font-family: monospace;
      padding: 12px;
      font-size: 14px; /* ★ readability */
      resize: none;
    }

    /* ------- SUPER MOBILE FRIENDLY MODE -------- */
    @media (max-width: 600px) {

      header { font-size: 20px; margin: 16px 0; }

      .app-frame {
        padding: 18px;
        border-radius: 18px;
        width: 98%;
      }

      .btn-primary,
      .btn-ghost {
        padding: 12px 24px;
        font-size: 16px;
      }

      .todo-item {
        flex-direction: column;
        align-items: flex-start;
        gap: 12px;
        padding: 16px;
      }

      .todo-left {
        gap: 14px;
      }

      .todo-check {
        width: 34px;
        height: 34px;
        font-size: 20px;
      }

      .todo-text {
        font-size: 18px;
      }

      .btn-small {
        padding: 10px 18px;
        font-size: 16px;
      }

      .todo-actions {
        width: 100%;
        justify-content: flex-end;
        gap: 12px;
      }

      #output {
        font-size: 15px;
        height: 180px;
      }
    }
  </style>
</head>

<body>
<header>WODO: TO-DO LIST</header>

<div class="app-frame">
  <!-- Toolbar -->
  <div class="toolbar">
    <div class="toolbar-left">
      <button id="addBtn" class="btn-primary">+ Add Task</button>
      <button id="clearBtn" class="btn-ghost">Clear All</button>
    </div>
    <span id="counter" style="font-size:15px; color:#9ca3af;"></span>
  </div>

  <!-- Task List -->
  <ul id="todoList" class="todo-list">
    <li class="todo-empty">No tasks yet. Press <strong>Add Task</strong> or hit <strong>N</strong>.</li>
  </ul>

  <textarea id="output" readonly></textarea>
</div>

<!-- JS / WASM Logic -->
<script>
function logLine(msg) {
  const out = document.getElementById("output");
  out.value += msg + "\n";
  out.scrollTop = out.scrollHeight;
}

var Module = {
  print: function() { logLine(Array.from(arguments).join(" ")); },
  onRuntimeInitialized: function() { setupTodoBindings(); }
};

function setupTodoBindings() {
  const cGetCount = Module.cwrap("getTaskCount", "number", []);
  const cGetTitle = Module.cwrap("getTaskTitle", "string", ["number"]);
  const cGetDone  = Module.cwrap("getTaskCompleted", "number", ["number"]);
  const cAdd      = Module.cwrap("addTask", null, ["string"]);
  const cDelete   = Module.cwrap("deleteTask", null, ["number"]);
  const cToggle   = Module.cwrap("toggleTask", null, ["number"]);
  const cEdit     = Module.cwrap("editTask", null, ["number", "string"]);
  const cClear    = Module.cwrap("clearTasks", null, []);

  function saveToStorage() {
    const n = cGetCount();
    const arr = [];
    for (let i = 0; i < n; i++) {
      arr.push({ title: cGetTitle(i), completed: !!cGetDone(i) });
    }
    localStorage.setItem("wasm-todo-tasks", JSON.stringify(arr));
  }

  function loadFromStorage() {
    const raw = localStorage.getItem("wasm-todo-tasks");
    cClear();
    if (!raw) { renderList(); return; }

    const arr = JSON.parse(raw);
    for (const item of arr) {
      cAdd(item.title);
      if (item.completed) {
        const idx = cGetCount() - 1;
        if (!cGetDone(idx)) cToggle(idx);
      }
    }
    renderList();
  }

  function escapeHtml(str) {
    return str.replace(/&/g,"&amp;")
      .replace(/</g,"&lt;").replace(/>/g,"&gt;")
      .replace(/"/g,"&quot;").replace(/'/g,"&#039;");
  }

  function renderList() {
    const list = document.getElementById("todoList");
    const counter = document.getElementById("counter");
    list.innerHTML = "";

    const n = cGetCount();
    counter.textContent = n === 1 ? "1 task" : `${n} tasks`;

    if (n === 0) {
      list.innerHTML = `<li class="todo-empty">No tasks yet. Press <strong>Add Task</strong> or hit <strong>N</strong>.</li>`;
      return;
    }

    for (let i = 0; i < n; i++) {
      const done = !!cGetDone(i);
      const li = document.createElement("li");
      li.className = "todo-item" + (done ? " done" : "");
      li.dataset.index = i;

      li.innerHTML = `
        <div class="todo-left">
          <div class="todo-check" data-role="toggle">${done ? "✓" : ""}</div>
          <div class="todo-text" data-role="toggle">${escapeHtml(cGetTitle(i))}</div>
        </div>
        <div class="todo-actions">
          <button class="btn-small edit" data-role="edit">Edit</button>
          <button class="btn-small delete" data-role="delete">×</button>
        </div>
      `;

      list.appendChild(li);
    }
  }

  document.getElementById("addBtn").addEventListener("click", () => {
    const t = prompt("Enter new task:");
    if (!t || !t.trim()) return;
    cAdd(t.trim());
    saveToStorage();
    renderList();
    logLine("+ Added: " + t.trim());
  });

  document.getElementById("clearBtn").addEventListener("click", () => {
    if (!confirm("Clear all tasks?")) return;
    cClear();
    saveToStorage();
    renderList();
    logLine("List cleared.");
  });

  document.getElementById("todoList").addEventListener("click", (e) => {
    const li = e.target.closest(".todo-item");
    if (!li) return;
    const idx = +li.dataset.index;
    const role = e.target.dataset.role;

    if (role === "toggle") {
      cToggle(idx);
      saveToStorage();
      renderList();
      return;
    }
    if (role === "delete") {
      if (!confirm("Delete this task?")) return;
      cDelete(idx);
      saveToStorage();
      renderList();
      return;
    }
    if (role === "edit") {
      const current = cGetTitle(idx);
      const t = prompt("Edit task:", current);
      if (!t || !t.trim()) return;
      cEdit(idx, t.trim());
      saveToStorage();
      renderList();
    }
  });

  window.addEventListener("keydown", (e) => {
    if (e.key === "n" || e.key === "N") {
      document.getElementById("addBtn").click();
    }
  });

  loadFromStorage();
  logLine("WASM To-Do ready. Press N to add tasks.");
}
</script>

<script>
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('sw.js?' + Date.now());
  }
</script>

<script src="todo.js"></script>
</body>
</html>
